@page "/pos"
@inject IAccountProductCategoryService AccountProductCategoryService
@inject IAccountProductSubCategoryService AccountProductSubCategoryService
@inject IAccountProductService AccountProductService

@inject NavigationManager Navigation
@inject NotificationService NotificationService

@using ClubFitnessDomain
@using ClubFitnessServices.Interfaces

@rendermode RenderMode.InteractiveServer

<div class="container-fluid">
    <div class="row">
        <div class="col-md-5 shadow-lg ps-4 py-3">
            @if (IsShowAccountProductCategory)
            {
                <AccountProductCategoryGrid Categories="categories"
                                            OnCategorySelected="OnCategorySelected" />
            }

            @if (IsShowAccountProductSubCategory)
            {
                if (selectedCategory != null)
                {
                    <AccountProductSubCategoryGrid SubCategories="subCategories" OnSubCategorySelected="OnSubCategorySelected" />
                }
                else
                {
                    <span>No sub-category found</span>
                }
            }

            @if (IsShowAccountProduct)
            {
                if (selectedSubCategory != null)
                {
                    <AccountProductGrid Products="products" OnProductSelected="OnProductSelected" />
                }
                else
                {
                    <span>No item found</span>
                }

            }
        </div>
        <!-- Transaction Item Grid Partial -->
        <div class="col-md-7">
            <AccountPosTransactionGrid 
                Tax="GetTax()"
                TransactionItems="transactionItems" 
                OnIncreaseQuantity="IncreaseQuantity" OnDecreaseQuantity="DecreaseQuantity" />
        </div>
    </div>
    <div class="row">
        <div class="col-6 mt-4">
            <RadzenButton Text="Back To Home" Click="@(() => BackToHome())" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small" />
            @if (IsShowAccountProductSubCategory)
            {
                <RadzenButton Text="Back To Category" Click="@(() => BackToCategory())" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small" />
            }

            @if (IsShowAccountProduct)
            {
                <RadzenButton Text="Back To Sub-Category" Click="@(() => BackToSubCategory())" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small" />
            }
        </div>
    </div>
</div>
@code {
    private IEnumerable<AccountProductCategory> categories;
    private IEnumerable<AccountProductSubCategory> subCategories;
    private IEnumerable<AccountProduct> products;
    private AccountProductCategory selectedCategory;
    private AccountProductSubCategory selectedSubCategory;
    private decimal Tax = 0.00M; //TODO: replace value from the settings
    private List<PosTransactionItem> transactionItems = new();

    bool IsShowAccountProductCategory = true;
    bool IsShowAccountProductSubCategory = false;
    bool IsShowAccountProduct = false;

    protected override async Task OnInitializedAsync()
    {
        categories = await AccountProductCategoryService.GetAllAsync();
    }

    private async Task OnCategorySelected(AccountProductCategory category)
    {
        selectedCategory = category;
        subCategories = await AccountProductSubCategoryService.GetSubCategoriesByCategoryId(category.AccountProductCategoryId);
        IsShowAccountProductCategory = !subCategories.Any();
        IsShowAccountProductSubCategory = subCategories.Any();

    }

    private async Task OnSubCategorySelected(AccountProductSubCategory subCategory)
    {
        selectedSubCategory = subCategory;
        products = await AccountProductService.GetProductsBySubCategoryId(subCategory.AccountProductSubCategoryId);
        IsShowAccountProductSubCategory = !products.Any();
        IsShowAccountProduct = products.Any();
    }

    private void OnProductSelected(AccountProduct product)
    {
        try
        {
            var existingItem = transactionItems.FirstOrDefault(p => p.ProductId == product.AccountProductId);

            if (existingItem != null)
            {
                existingItem.ItemQuantity += 1;
            }
            else
            {
                transactionItems.Add(new PosTransactionItem
                    {
                        ProductId = product.AccountProductId,
                        ItemDescription = product.ProductName ?? "",
                        ItemPriceIncTax = product.SellIncTaxPrice ?? 0,
                        ItemPriceExTax = product.SellExTaxPrice ?? 0,
                        ItemQuantity = 1,
                        ProductImage = product.DisplayImagePath ?? ""// Assuming Product Image is in DisplayImagePath
                    });

                // Notify UI to update the transaction items list
                transactionItems = transactionItems.ToList();

                NotificationService.Notify(NotificationSeverity.Success, "Added", "New item has been added.");
            }

        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            throw;
        }
    }

    private void IncreaseQuantity(PosTransactionItem item)
    {
        item.ItemQuantity += 1;
        // Notify UI to update the transaction items list
        transactionItems = transactionItems.ToList();
    }

    private void DecreaseQuantity(PosTransactionItem item)
    {
        if (item.ItemQuantity > 1)
        {
            item.ItemQuantity -= 1;
        }
        else
        {
            transactionItems.Remove(item);

            NotificationService.Notify(NotificationSeverity.Success, "Removed", "Item has been removed.");
        }

        // Notify UI to update the transaction items list
        transactionItems = transactionItems.ToList();
    }

    private decimal GetTax()
    {
        decimal vat = 12M; //replace with setting value

        return vat / 100;
    }

    private void BackToHome()
    {
        Navigation.NavigateTo("/");
    }

    private void BackToCategory()
    {
        IsShowAccountProductCategory = true;
        IsShowAccountProductSubCategory = false;
    }

    private void BackToSubCategory()
    {
        IsShowAccountProductSubCategory = true;
        IsShowAccountProduct = false;
    }

}
